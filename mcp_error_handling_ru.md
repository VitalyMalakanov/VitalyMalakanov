## 6. Обработка ошибок в MCP

Model Context Protocol (MCP) использует стандартный механизм обработки ошибок, определенный в спецификации **JSON-RPC 2.0**. Это обеспечивает унифицированный подход к сообщению о проблемах, возникающих во время взаимодействия между клиентом и сервером.

### Стандартные коды ошибок (Standard Error Codes)

JSON-RPC 2.0 определяет набор стандартных кодов ошибок, которые должны использоваться для обозначения общих проблем протокольного уровня. MCP полностью придерживается этих кодов:

*   **`-32700 ParseError (Ошибка разбора)`:**
    *   **Значение:** Сервер получил некорректно сформированный JSON. Сообщение не удалось разобрать как валидный JSON-документ.
    *   **Пример:** Клиент отправляет строку `{"jsonrpc": "2.0", "method": "foo"` (незакрытая кавычка).

*   **`-32600 InvalidRequest (Некорректный запрос)`:**
    *   **Значение:** Отправленный JSON является валидным, но сам запрос не соответствует спецификации JSON-RPC 2.0.
    *   **Пример:** Отсутствует обязательное поле `jsonrpc: "2.0"` или поле `method`. Запрос является уведомлением, но содержит поле `id`.

*   **`-32601 MethodNotFound (Метод не найден)`:**
    *   **Значение:** Указанный в поле `method` запроса метод не существует или недоступен на сервере.
    *   **Пример:** Клиент вызывает метод `server/nonExistentMethod`.

*   **`-32602 InvalidParams (Некорректные параметры)`:**
    *   **Значение:** Метод существует, но предоставленные параметры (`params`) недействительны или не соответствуют ожиданиям метода (например, неверный тип, отсутствуют обязательные параметры, переданы избыточные параметры, которые метод не может обработать).
    *   **Пример:** Метод ожидает параметр `count` как число, но получает строку: `{"count": "abc"}`.

*   **`-32603 InternalError (Внутренняя ошибка)`:**
    *   **Значение:** Указывает на внутреннюю ошибку на стороне сервера при обработке запроса. Эта ошибка обычно означает проблему в коде самого сервера, не связанную напрямую с корректностью или содержимым запроса.
    *   **Пример:** Необработанное исключение в логике серверного метода, проблема с доступом к базе данных на стороне сервера.

Спецификация JSON-RPC также резервирует диапазон кодов от `-32000` до `-32099` для предопределенных ошибок сервера. **SDK и приложения могут определять собственные пользовательские коды ошибок (custom error codes) со значениями выше -32000.** Это позволяет передавать специфичные для приложения ошибки, которые не покрываются стандартными кодами.

### Структура объекта ошибки (Error Object Structure)

Когда запрос не может быть успешно выполнен, сервер возвращает JSON-RPC ответ, который вместо поля `result` содержит поле `error`. Этот объект `error` имеет следующую стандартизированную структуру:

*   `code`: (Число, Integer) Целочисленный код, который идентифицирует тип ошибки (один из стандартных или пользовательский код).
*   `message`: (Строка, String) Краткое, человекочитаемое описание ошибки. Это сообщение в первую очередь предназначено для разработчиков или для логирования и не всегда подходит для прямого отображения конечным пользователям.
*   `data` (необязательное): (Любой тип, Any) Дополнительное поле, которое может содержать структурированные данные, относящиеся к конкретной ошибке. Содержимое этого поля определяется сервером. Например, для ошибки `InvalidParams` оно может содержать информацию о том, какой именно параметр был неверным.

**Пример объекта ошибки в ответе:**
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32602,
    "message": "Invalid params: 'count' parameter must be an integer.",
    "data": {
      "field": "count",
      "expectedType": "integer",
      "actualType": "string"
    }
  },
  "id": "request-id-789"
}
```

### Распространение ошибок (Error Propagation)

Ошибки в системе, использующей MCP, могут возникать и должны обрабатываться на различных уровнях:

1.  **Через объекты `error` в ответах на запросы:**
    *   Это основной и наиболее явный способ сообщения об ошибках, связанных с обработкой конкретного запроса. Клиент, отправивший запрос, должен всегда проверять, содержит ли ответ поле `result` или `error`.

2.  **Через события ошибок на транспортном уровне:**
    *   Проблемы могут возникнуть на уровне самого транспортного соединения (например, Stdio, HTTP/SSE). Примеры таких проблем:
        *   Разрыв TCP-соединения для HTTP/SSE.
        *   Неожиданное закрытие потоков `stdin`/`stdout` для Stdio.
        *   Ошибки HTTP-протокола (например, код состояния `404 Not Found` если эндпоинт MCP не существует, или `503 Service Unavailable`).
    *   Эти ошибки обычно приводят к полному разрыву MCP-соединения. SDK должны предоставлять механизмы для отслеживания состояния транспортного соединения и уведомления приложения о таких событиях (например, через колбэки `onDisconnected` или события `transportError`).

3.  **Через обработчики ошибок на уровне протокола/SDK:**
    *   SDK могут предоставлять глобальные обработчики ошибок или события для проблем, которые не связаны с конкретным запросом-ответом, но влияют на состояние протокола. Например:
        *   Ошибки десериализации сообщения, которое не является ни запросом, ни ответом, ни уведомлением.
        *   Тайм-ауты ожидания ответа на запрос (если реализованы в SDK).
        *   Проблемы во время фазы инициализации, не покрываемые стандартным ответом-ошибкой на `initialize`.
    *   Эти механизмы позволяют приложению централизованно реагировать на общие проблемы связи или протокола.

Надлежащая стратегия обработки ошибок включает проверку ответов на наличие поля `error`, готовность к неожиданным разрывам соединения и, при необходимости, реализацию логики повторных попыток или информирования пользователя о проблеме.
