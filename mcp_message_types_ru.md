## 4. Типы сообщений в MCP

Model Context Protocol (MCP) полностью основывается на спецификации **JSON-RPC 2.0** для определения структуры и семантики сообщений, которыми обмениваются клиент и сервер. JSON-RPC 2.0 определяет четыре основных типа сообщений, каждый из которых служит уникальной цели в рамках протокола. Все сообщения являются объектами JSON.

### 1. Запросы (Requests)

**Назначение:** Сообщение-запрос отправляется одной стороной (клиентом или сервером) другой стороне для вызова определенного метода (процедуры) и получения ответа.

**Структура и ключевые поля:**

*   `jsonrpc`: Строка, значение которой **должно быть** точно `"2.0"`.
*   `method`: Строка, содержащая имя вызываемого метода (например, `textDocument/didOpen`, `initialize`, `$/setTrace`). Имена, начинающиеся с `$/`, зарезервированы для системных (predefined) уведомлений и запросов.
*   `params` (необязательное): Объект или массив, содержащий параметры, передаваемые вызываемому методу. Если параметры не нужны, это поле может быть опущено.
*   `id`: Уникальный идентификатор, устанавливаемый отправителем запроса. Может быть строкой, числом или (в редких случаях) `null`. Это поле **обязательно** для запросов, ожидающих ответ. Сервер использует тот же `id` в своем ответе (результате или ошибке), чтобы клиент мог сопоставить ответ с исходным запросом.

**Пример запроса:**

Клиент запрашивает у сервера список доступных ресурсов, фильтруя их по типу "документы".

```json
{
  "jsonrpc": "2.0",
  "method": "listResources",
  "params": { "filter": "documents" },
  "id": "req-001"
}
```

### 2. Ответы на запросы / Результаты (Results)

**Назначение:** Сообщение-ответ (или результат) отправляется получателем запроса в случае его успешного выполнения. Оно содержит результат работы вызванного метода.

**Структура и ключевые поля:**

*   `jsonrpc`: Строка, значение которой **должно быть** точно `"2.0"`.
*   `result`: Поле, содержащее данные, являющиеся результатом выполнения запроса. Значение этого поля может быть любым валидным JSON-типом (объект, массив, строка, число, булево значение, `null`), в зависимости от спецификации метода.
*   `id`: Точно такой же идентификатор, который был указан в поле `id` исходного запроса. Это поле **обязательно**.

**Пример ответа с результатом:**

Сервер успешно обработал запрос `req-001` и возвращает список ресурсов.

```json
{
  "jsonrpc": "2.0",
  "result": [
    { "uri": "file:///home/user/doc1.txt", "name": "Документ 1", "type": "document" },
    { "uri": "file:///home/user/report.docx", "name": "Отчет.docx", "type": "document" }
  ],
  "id": "req-001"
}
```

### 3. Ошибки (Errors)

**Назначение:** Сообщение об ошибке отправляется получателем запроса, если запрос не может быть выполнен или в процессе его выполнения произошла ошибка.

**Структура и ключевые поля:**

*   `jsonrpc`: Строка, значение которой **должно быть** точно `"2.0"`.
*   `error`: Объект, содержащий детализированную информацию об ошибке. Этот объект **обязателен**.
    *   `code`: Целое число, указывающее тип произошедшей ошибки (например, стандартные коды JSON-RPC, такие как `-32601` для "Method not found").
    *   `message`: Строка, предоставляющая краткое описание ошибки.
    *   `data` (необязательное): Дополнительное, специфичное для ошибки, значение. Может содержать более подробную информацию или структурированные данные об ошибке.
*   `id`: Точно такой же идентификатор, который был указан в поле `id` исходного запроса. Если ошибка не может быть ассоциирована с конкретным запросом (например, ошибка разбора JSON, когда `id` не может быть извлечен), это поле **должно быть** `null`.

**Пример сообщения об ошибке:**

Сервер не смог найти метод `listResourcess` (опечатка в имени метода), запрошенный клиентом с `id: "req-002"`.

```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32601,
    "message": "Method not found: listResourcess",
    "data": {
      "details": "The method 'listResourcess' does not exist. Did you mean 'listResources'?"
    }
  },
  "id": "req-002"
}
```

### 4. Уведомления (Notifications)

**Назначение:** Уведомления — это сообщения, которые отправляются для информирования другой стороны о каком-либо событии. В отличие от запросов, уведомления **не предполагают ответа**. Это однонаправленная коммуникация. Если при обработке уведомления возникает ошибка, она не отправляется обратно отправителю.

**Структура и ключевые поля:**

*   `jsonrpc`: Строка, значение которой **должно быть** точно `"2.0"`.
*   `method`: Строка, содержащая имя метода уведомления (например, `textDocument/didChange`, `$/initialized`).
*   `params` (необязательное): Объект или массив, содержащий параметры для уведомления.

**Ключевое отличие от запроса:** Поле `id` **ДОЛЖНО ОТСУТСТВОВАТЬ**. Именно отсутствие `id` указывает на то, что сообщение является уведомлением, а не запросом.

**Пример уведомления:**

Сервер уведомляет клиента о том, что он успешно завершил процесс инициализации.

```json
{
  "jsonrpc": "2.0",
  "method": "initialized"
}
```
Другой пример: клиент уведомляет сервер об изменении конфигурации.
```json
{
  "jsonrpc": "2.0",
  "method": "workspace/didChangeConfiguration",
  "params": {
    "settings": {
      "editor.fontSize": 14
    }
  }
}
```
